---
layout: post
title: "LightGBMをCommon Lispから使う"
description: ""
category: 
tags: [lisp,machine-learning]
---
{% include JB/setup %}

# LightGBMをソースからインストール

- [LightGBM(github)](https://github.com/Microsoft/LightGBM)

ホームディレクトリ直下に置くことに注意する。
最新のmasterを入れた(現時点でv3.3.5)。以下のようにして手元でビルドする。

```sh
cd ~/
git clone --recursive https://github.com/microsoft/LightGBM
cd LightGBM
mkdir build
cd build
cmake ..
make -j4
```

# Common Lispバインディングをインストール

- [lightgbm(Common Lispバインディング)](https://gitlab.common-lisp.net/cungil/lightgbm)

cl-autowrapを使っているため、libffiが必要。
roswellを使っている前提で、`~/.roswell/local-projects` 以下にgit cloneする。
最新のcommitでv3.3.2に対応したと書いてあったが最新のLightGBMでも動いた。

```sh
cd ~/.roswell/local-project
git clone git@common-lisp.net:cungil/lightgbm.git
```

# SBCLからロードしてみる

quickloadでロードできる。
ここでライブラリが見つからない場合はlightgbm/wrapper.lispを見る。ホームディレクトリ直下にLightGBMディレクトリがあることを仮定しているようだった。

```lisp
(ql:quickload :lightgbm)

```

# テスト実行

テストは以下のようにすると実行できる。

```lisp
;; テスト実行
(asdf:test-system :lightgbm/test)

#|
Running test suite LIGHTGBM-SUITE
 Running test READ-DATA .
 Running test EMPTY-DATASET .
 Running test NUM-CLASSES .
 Running test FEATURE-NAMES .
 Running test FEATURE-NAMES-SET .
 Running test FEATURE-NAMES-BOOSTER .
 Running test UPDATE-PARAM-CHECK .
 Running test BOOSTER-TO-STRING f
 Running test DUMP-MODEL f
 Running test EARLY-STOPPING 
[0]    train l2: 0.244602  train auc: 0.738768  valid-1 l2: 0.244076  valid-1 auc: 0.722112
[1]    train l2: 0.240556  train auc: 0.780544  valid-1 l2: 0.240297  valid-1 auc: 0.773591
[2]    train l2: 0.235815  train auc: 0.791324  valid-1 l2: 0.235733  valid-1 auc: 0.781387
[3]    train l2: 0.231278  train auc: 0.795224  valid-1 l2: 0.231352  valid-1 auc: 0.785039
[4]    train l2: 0.227683  train auc: 0.803645  valid-1 l2: 0.228939  valid-1 auc: 0.778678
[5]    train l2: 0.224675  train auc: 0.808916  valid-1 l2: 0.225930  valid-1 auc: 0.790538
[6]    train l2: 0.221149  train auc: 0.812187  valid-1 l2: 0.222515  valid-1 auc: 0.793174
[7]    train l2: 0.217942  train auc: 0.814030  valid-1 l2: 0.219569  valid-1 auc: 0.793803
[8]    train l2: 0.214806  train auc: 0.814784  valid-1 l2: 0.216800  valid-1 auc: 0.791699
[9]    train l2: 0.211968  train auc: 0.814482  valid-1 l2: 0.214371  valid-1 auc: 0.790836
...
|#
```
# データセット

ドキュメントとかはないようなので、テストファイルを読み解いて基本的な使い方を見ていく。

## ファイルからデータをロード

### 訓練データをロードする

リポジトリに付属しているサンプルデータを読み込んでみる。

```lisp
(defparameter train-data
  (lgbm:read-data-file #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.train"))
; train-data => #<LIGHTGBM::LGBM-DATASET 7000x28 LABEL>
```

データファイルの冒頭はこうなっている。
タブ区切りのテキストファイルで先頭要素が教師信号になっている(この場合は二値分類なので1 or 0)
データファイルはCSV, TSV, libsvmフォーマットが利用可能とのこと。

```
1	0.869	-0.635	0.226	0.327	-0.690	0.754	-0.249	-1.092	0.000	1.375	-0.654	0.930	1.107	1.139	-1.578	-1.047	0.000	0.658	-0.010	-0.046	3.102	1.354	0.980	0.978	0.920	0.722	0.989	0.877
1	0.908	0.329	0.359	1.498	-0.313	1.096	-0.558	-1.588	2.173	0.813	-0.214	1.271	2.215	0.500	-1.261	0.732	0.000	0.399	-1.139	-0.001	0.000	0.302	0.833	0.986	0.978	0.780	0.992	0.798
1	0.799	1.471	-1.636	0.454	0.426	1.105	1.282	1.382	0.000	0.852	1.541	-0.820	2.215	0.993	0.356	-0.209	2.548	1.257	1.129	0.900	0.000	0.910	1.108	0.986	0.951	0.803	0.866	0.780
0	1.344	-0.877	0.936	1.992	0.882	1.786	-1.647	-0.942	0.000	2.423	-0.676	0.736	2.215	1.299	-1.431	-0.365	0.000	0.745	-0.678	-1.360	0.000	0.947	1.029	0.999	0.728	0.869	1.027	0.958
...
```

`lgbm:read-data-file` の返値は `LGBM-DATASET` というクラスのオブジェクトだが、中身はポインタなのでCの構造体へのポインタなのだろう。
データセットに対するメソッド

```lisp
;; データセットの形状
(lgbm:dims train-data) ; => (7000 28)
(lgbm:nrow train-data) ; => 7000
(lgbm:nfeatures train-data) ; => 28

;; 特徴名(ある場合)
(lgbm:feature-names train-data)

; ("Column_0" "Column_1" "Column_2" "Column_3" "Column_4" "Column_5" "Column_6"
;  "Column_7" "Column_8" "Column_9" "Column_10" "Column_11" "Column_12"
;  "Column_13" "Column_14" "Column_15" "Column_16" "Column_17" "Column_18"
;  "Column_19" "Column_20" "Column_21" "Column_22" "Column_23" "Column_24"
;  "Column_25" "Column_26" "Column_27")

;; fieldメソッドでデータセットの一部を取り出せる

;; 教師信号をリストとして取り出す
(lgbm:field train-data :label)
; => (1.0 1.0 1.0 0.0 ...)
```

### テストデータをロードする

テストデータをロードする時には訓練データへの参照を入れる必要があることに注意。

```lisp
(defparameter test-data
  (lgbm:read-data-file (merge-pathnames "examples/binary.test" src-dir)
                       :reference train-data))
```

## データセットからモデルを作り、訓練する

`lgbm:booster`メソッドで訓練データを指定してモデルを作れる。
この時点では訓練されておらず、 `lgbm:train`で訓練する。

```lisp
(defparameter model (lgbm:booster train-data))

;; データを何周するかを指定して訓練する

(lgbm:train model 10)

#|
[0]    train l2: 0.238643
[1]    train l2: 0.229898
[2]    train l2: 0.222344
[3]    train l2: 0.215907
[4]    train l2: 0.210251
[5]    train l2: 0.205303
[6]    train l2: 0.200922
[7]    train l2: 0.197002
[8]    train l2: 0.193583
[9]    train l2: 0.190432
(("train" "l2" 0.2386427619778241d0 0.22989769815398528d0 0.22234391028374623d0
  0.21590656551973061d0 0.21025111291736295d0 0.20530299011235634d0
  0.20092151907590491d0 0.19700195198301462d0 0.1935828883937399d0
  0.190431655495415d0))
|#
```

テストデータを指定することで

## 獲得したモデルから予測する

```lisp
(lgbm:predict-file model
                   #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.test"
                   #P"/tmp/out")
; => NIL

(defparameter test-data
  (lgbm:read-data-file #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.test"))

(lgbm:dims test-data) ; => (500 28)

```
