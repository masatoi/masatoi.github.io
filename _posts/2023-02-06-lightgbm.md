---
layout: post
title: "LightGBMをCommon Lispから使う"
description: ""
category: 
tags: [lisp,machine-learning]
---
{% include JB/setup %}

# LightGBMをソースからインストール

- [LightGBM(github)](https://github.com/Microsoft/LightGBM)

ホームディレクトリ直下に置くことに注意。
最新のmasterを入れた(現時点でv3.3.5)。手元でビルドする。

```sh
cd ~/
git clone --recursive https://github.com/microsoft/LightGBM
cd LightGBM
mkdir build
cd build
cmake ..
make -j4
```

# Common Lispバインディングをインストール

- [lightgbm(Common Lispバインディング)](https://gitlab.common-lisp.net/cungil/lightgbm)

roswellを使っている前提でlocal-project以下にgit cloneする。
最新のcommitでv3.3.2に対応したと書いてあるから最新のLightGBMで動くかは不明。

```sh
cd ~/.roswell/local-project
git clone git@common-lisp.net:cungil/lightgbm.git
```

# SBCLからロードしてみる

とりあえず以下でロードはできた。
ライブラリが見つからない場合はlightgbm/wrapper.lispを見る。ホームディレクトリ直下にLightGBMディレクトリがあることを仮定しているようだった。

```lisp
(ql:quickload :lightgbm)

```

# テスト実行

とりあえずテストは通過。

```lisp
;; テスト実行
(asdf:test-system :lightgbm/test)

#|
Running test suite LIGHTGBM-SUITE
 Running test READ-DATA .
 Running test EMPTY-DATASET .
 Running test NUM-CLASSES .
 Running test FEATURE-NAMES .
 Running test FEATURE-NAMES-SET .
 Running test FEATURE-NAMES-BOOSTER .
 Running test UPDATE-PARAM-CHECK .
 Running test BOOSTER-TO-STRING f
 Running test DUMP-MODEL f
 Running test EARLY-STOPPING 
[0]    train l2: 0.244602  train auc: 0.738768  valid-1 l2: 0.244076  valid-1 auc: 0.722112
[1]    train l2: 0.240556  train auc: 0.780544  valid-1 l2: 0.240297  valid-1 auc: 0.773591
[2]    train l2: 0.235815  train auc: 0.791324  valid-1 l2: 0.235733  valid-1 auc: 0.781387
[3]    train l2: 0.231278  train auc: 0.795224  valid-1 l2: 0.231352  valid-1 auc: 0.785039
[4]    train l2: 0.227683  train auc: 0.803645  valid-1 l2: 0.228939  valid-1 auc: 0.778678
[5]    train l2: 0.224675  train auc: 0.808916  valid-1 l2: 0.225930  valid-1 auc: 0.790538
[6]    train l2: 0.221149  train auc: 0.812187  valid-1 l2: 0.222515  valid-1 auc: 0.793174
[7]    train l2: 0.217942  train auc: 0.814030  valid-1 l2: 0.219569  valid-1 auc: 0.793803
[8]    train l2: 0.214806  train auc: 0.814784  valid-1 l2: 0.216800  valid-1 auc: 0.791699
[9]    train l2: 0.211968  train auc: 0.814482  valid-1 l2: 0.214371  valid-1 auc: 0.790836
...
|#
```
# データセット

ドキュメントとかはないようなので、テストファイルを読み解いて基本的な使い方を見ていく。

## ファイルからデータをロード

```lisp
(defparameter train-data
  (lgbm:read-data-file #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.train"))
; train-data => #<LIGHTGBM::LGBM-DATASET 7000x28 LABEL>
```

データファイルの冒頭はこうなっている。
タブ区切りのテキストファイルで先頭要素が教師信号になっている(この場合は二値分類なので1 or 0)

```
1	0.869	-0.635	0.226	0.327	-0.690	0.754	-0.249	-1.092	0.000	1.375	-0.654	0.930	1.107	1.139	-1.578	-1.047	0.000	0.658	-0.010	-0.046	3.102	1.354	0.980	0.978	0.920	0.722	0.989	0.877
1	0.908	0.329	0.359	1.498	-0.313	1.096	-0.558	-1.588	2.173	0.813	-0.214	1.271	2.215	0.500	-1.261	0.732	0.000	0.399	-1.139	-0.001	0.000	0.302	0.833	0.986	0.978	0.780	0.992	0.798
1	0.799	1.471	-1.636	0.454	0.426	1.105	1.282	1.382	0.000	0.852	1.541	-0.820	2.215	0.993	0.356	-0.209	2.548	1.257	1.129	0.900	0.000	0.910	1.108	0.986	0.951	0.803	0.866	0.780
0	1.344	-0.877	0.936	1.992	0.882	1.786	-1.647	-0.942	0.000	2.423	-0.676	0.736	2.215	1.299	-1.431	-0.365	0.000	0.745	-0.678	-1.360	0.000	0.947	1.029	0.999	0.728	0.869	1.027	0.958
...
```

返値はLGBM-DATASETというクラスのオブジェクトだが、中身はポインタなのでCの構造体へのポインタなのだろう。
データセットに対するメソッド

```lisp
;; データセットの形状
(lgbm:dims train-data) ; => (7000 28)
(lgbm:nrow train-data) ; => 7000
(lgbm:nfeatures train-data) ; => 28

;; 特徴名(ある場合)
(lgbm:feature-names train-data)

; ("Column_0" "Column_1" "Column_2" "Column_3" "Column_4" "Column_5" "Column_6"
;  "Column_7" "Column_8" "Column_9" "Column_10" "Column_11" "Column_12"
;  "Column_13" "Column_14" "Column_15" "Column_16" "Column_17" "Column_18"
;  "Column_19" "Column_20" "Column_21" "Column_22" "Column_23" "Column_24"
;  "Column_25" "Column_26" "Column_27")

;; fieldメソッドでデータセットの一部を取り出せる

;; 教師信号をリストとして取り出す
(lgbm:field train-data :label)
; => (1.0 1.0 1.0 0.0 ...)
```

## データセットからモデルを作る(学習する)

`booster`メソッドでデータからモデルを作れる

```
(defparameter model (lgbm:booster train-data))

;; モデルの情報を文字列に出力
(save model :string)

"tree
version=v4
num_class=1
num_tree_per_iteration=1
label_index=0
max_feature_idx=27
objective=regression
feature_names=Column_0 Column_1 Column_2 Column_3 Column_4 Column_5 Column_6 Column_7 Column_8 Column_9 Column_10 Column_11 Column_12 Column_13 Column_14 Column_15 Column_16 Column_17 Column_18 Column_19 Column_20 Column_21 Column_22 Column_23 Column_24 Column_25 Column_26 Column_27
feature_infos=[0.27500000000000002:6.6950000000000003] [-2.4169999999999998:2.4300000000000002] [-1.7429999999999999:1.7429999999999999] [0.019:5.7000000000000002] [-1.7429999999999999:1.7429999999999999] [0.159:4.1900000000000004] [-2.9409999999999998:2.9699999999999998] [-1.7410000000000001:1.7410000000000001] [0:2.173] [0.19:5.1929999999999996] [-2.9039999999999999:2.9089999999999998] [-1.742:1.7429999999999999] [0:2.2149999999999999] [0.26400000000000001:6.5229999999999997] [-2.7279999999999998:2.7269999999999999] [-1.742:1.742] [0:2.548] [0.36499999999999999:6.0679999999999996] [-2.4950000000000001:2.496] [-1.74:1.7429999999999999] [0:3.1019999999999999] [0.17199999999999999:13.098000000000001] [0.41899999999999998:7.3920000000000003] [0.46100000000000002:3.6819999999999999] [0.38400000000000001:6.5830000000000002] [0.092999999999999999:7.8600000000000003] [0.38900000000000001:4.5430000000000001] [0.48899999999999999:4.3159999999999998]
tree_sizes=

end of trees

feature_importances:

parameters:
[boosting: gbdt]
[objective: regression]
[metric: l2]
[tree_learner: serial]
[device_type: cpu]
[data: ]
[valid: ]
[num_iterations: 100]
[learning_rate: 0.1]
[num_leaves: 31]
[num_threads: 0]
[deterministic: 0]
[force_col_wise: 0]
[force_row_wise: 0]
[histogram_pool_size: -1]
[max_depth: -1]
[min_data_in_leaf: 20]
[min_sum_hessian_in_leaf: 0.001]
[bagging_fraction: 1]
[pos_bagging_fraction: 1]
[neg_bagging_fraction: 1]
[bagging_freq: 0]
[bagging_seed: 3]
[feature_fraction: 1]
[feature_fraction_bynode: 1]
[feature_fraction_seed: 2]
[extra_trees: 0]
[extra_seed: 6]
[early_stopping_round: 0]
[first_metric_only: 0]
[max_delta_step: 0]
[lambda_l1: 0]
[lambda_l2: 0]
[linear_lambda: 0]
[min_gain_to_split: 0]
[drop_rate: 0.1]
[max_drop: 50]
[skip_drop: 0.5]
[xgboost_dart_mode: 0]
[uniform_drop: 0]
[drop_seed: 4]
[top_rate: 0.2]
[other_rate: 0.1]
[min_data_per_group: 100]
[max_cat_threshold: 32]
[cat_l2: 10]
[cat_smooth: 10]
[max_cat_to_onehot: 4]
[top_k: 20]
[monotone_constraints: ]
[monotone_constraints_method: basic]
[monotone_penalty: 0]
[feature_contri: ]
[forcedsplits_filename: ]
[refit_decay_rate: 0.9]
[cegb_tradeoff: 1]
[cegb_penalty_split: 0]
[cegb_penalty_feature_lazy: ]
[cegb_penalty_feature_coupled: ]
[path_smooth: 0]
[interaction_constraints: ]
[verbosity: 1]
[saved_feature_importance_type: 0]
[linear_tree: 0]
[max_bin: 255]
[max_bin_by_feature: ]
[min_data_in_bin: 3]
[bin_construct_sample_cnt: 200000]
[data_random_seed: 1]
[is_enable_sparse: 1]
[enable_bundle: 1]
[use_missing: 1]
[zero_as_missing: 0]
[feature_pre_filter: 1]
[pre_partition: 0]
[two_round: 0]
[header: 0]
[label_column: ]
[weight_column: ]
[group_column: ]
[ignore_column: ]
[categorical_feature: ]
[forcedbins_filename: ]
[precise_float_parser: 0]
[parser_config_file: ]
[objective_seed: 5]
[num_class: 1]
[is_unbalance: 0]
[scale_pos_weight: 1]
[sigmoid: 1]
[boost_from_average: 1]
[reg_sqrt: 0]
[alpha: 0.9]
[fair_c: 1]
[poisson_max_delta_step: 0.7]
[tweedie_variance_power: 1.5]
[lambdarank_truncation_level: 30]
[lambdarank_norm: 1]
[label_gain: ]
[eval_at: ]
[multi_error_top_k: 1]
[auc_mu_weights: ]
[num_machines: 1]
[local_listen_port: 12400]
[time_out: 120]
[machine_list_filename: ]
[machines: ]
[gpu_platform_id: -1]
[gpu_device_id: -1]
[gpu_use_dp: 0]
[num_gpu: 1]

end of parameters
"

(lgbm:train model 10)
[0]    train l2: 0.238643
[1]    train l2: 0.229898
[2]    train l2: 0.222344
[3]    train l2: 0.215907
[4]    train l2: 0.210251
[5]    train l2: 0.205303
[6]    train l2: 0.200922
[7]    train l2: 0.197002
[8]    train l2: 0.193583
[9]    train l2: 0.190432
(("train" "l2" 0.2386427619778241d0 0.22989769815398528d0 0.22234391028374623d0
  0.21590656551973061d0 0.21025111291736295d0 0.20530299011235634d0
  0.20092151907590491d0 0.19700195198301462d0 0.1935828883937399d0
  0.190431655495415d0))
```

## 獲得したモデルから予測する

```
(lgbm:predict-file model
                   #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.test"
                   #P"/tmp/out")
; => NIL

(defparameter test-data
  (lgbm:read-data-file #P"/home/wiz/.roswell/local-projects/lightgbm/examples/binary.test"))

(lgbm:dims test-data) ; => (500 28)

```
